<!DOCTYPE html>
<html>

<head>
    <base target="_top">
</head>

<body>
    <form id="dataForm">
        </label>
        <label>Client:
            <select name="client" required>
            </select>
        </label><br>

        <label>Project:
            <select name="project" required>
            </select>
            <input name="getProject" type="button" value="Get project [WIP]" onclick="getProjectFromClient()">
        </label><br>


        <label>Title: <input type="text" name="title" required></label><br>
        <label>Description:<br>
        <textarea name="description" rows="4" cols="50"></textarea>
      </label><br>
        <label>Employee:
        <select name="employee" required>
          
        </select>
      </label><br>
        <label>Priority:
        <select name="priority" required>
    
        </select>
      </label><br>
        <label>Status:
        <select name="status" required>

        </select>
      </label><br>

        <label>Due date:
            <input type="date" name="due_date">
        </label>
        <input type="submit" value="Create">
    </form>
    <script>
        //API_URL = 'http://127.0.0.1:8080/api';

        document.addEventListener("DOMContentLoaded", function(event) {
            fetch(`${API_URL}?command=getClients`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    populateClients(data)
                    console.log('Data received:', data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('Error: ' + error.message);
                });

            fetch(`${API_URL}?command=getProjects`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    populateProjects(data)
                    console.log('Data received:', data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('Error: ' + error.message);
                });

            fetch(`${API_URL}?command=getEmployees`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    populateEmployees(data)
                    console.log('Data received:', data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('Error: ' + error.message);
                });

            fetch(`${API_URL}?command=getTaskPriorities`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    populatePriorities(data)
                    console.log('Data received:', data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('Error: ' + error.message);
                });

            fetch(`${API_URL}?command=getTaskStatuses`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    populateStatuses(data)
                    console.log('Data received:', data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('Error: ' + error.message);
                });




        });

        function populateClients(clients) {
            const clientSelect = document.querySelector('select[name="client"]');
            clients.forEach(client => {
                if (client.first_name != "Null") {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.full_name;
                    clientSelect.appendChild(option);
                }
            });
        }

        function populateProjects(projects) {
            const projectSelect = document.querySelector('select[name="project"]');
            projects.forEach(project => {
                if (project.url != "Null") {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.url;
                    projectSelect.appendChild(option);
                }
            });
        }

        function populateEmployees(employees) {
            const employeeSelect = document.querySelector('select[name="employee"]');
            employees.forEach(employee => {
                if (employee.first_name != "Null") {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.full_name;
                    employeeSelect.appendChild(option);
                }
            });
        }

        function populatePriorities(priorities) {
            const prioritySelect = document.querySelector('select[name="priority"]');
            priorities.forEach(priority => {
                if (priority.name != "Null") {
                    const option = document.createElement('option');
                    option.value = priority.id;
                    option.textContent = priority.name;
                    prioritySelect.appendChild(option);
                }
            });
        }

        function populateStatuses(statuses) {
            const statusSelect = document.querySelector('select[name="status"]');
            statuses.forEach(status => {
                if (status.name != "Null") {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    statusSelect.appendChild(option);
                }
            });
        }

        function getProjectFromClient() {
            const clientSelect = document.querySelector('select[name="client"]');
            const projectSelect = document.querySelector('select[name="project"]');
            const clientId = clientSelect.value;

            fetch(`${API_URL}?command=getProjectsByClient&client_id=${clientId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    projectSelect.innerHTML = ''; // Clear existing options
                    data.forEach(project => {
                        if (project.url != "Null") {
                            const option = document.createElement('option');
                            option.value = project.id;
                            option.textContent = project.url;
                            projectSelect.appendChild(option);
                        }
                    });
                    console.log('Projects for client received:', data);
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    alert('Error: ' + error.message);
                });
        }
    </script>
    <script>
        document.getElementById("dataForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            var data = {
                client: formData.get("client"),
                project: formData.get("project"),
                title: formData.get("title"),
                description: formData.get("description"),
                employee: formData.get("employee"),
                priority: formData.get("priority"),
                status: formData.get("status"),
                due_date: formData.get("due_date") || null

            };
            fetch(`${API_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // or 'application/x-www-form-urlencoded'
                    },
                    body: JSON.stringify({
                        command: 'insert_task',
                        task_data: data
                    })
                })
                .then(response => response.json()) // or response.text() if it's plain text
                .then(data => {
                    console.log('Success:', data);
                    google.script.host.close();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                });

        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');
        body {
            font-family: Roboto;
        }
        
        form {
            display: flex;
            flex-direction: column;
            width: 300px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        form label {
            display: flex;
            flex-direction: column;
        }
        
        form input,
        form select,
        form textarea {
            font-family: Roboto;
            font-size: 16px;
            padding: 5px;
        }
        
        form textarea {
            resize: vertical;
        }
        
        form label {
            font-family: Roboto;
            font-size: 16px;
        }
        
        form input[type="submit"] {
            background-color: #006ee6;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            text-transform: uppercase;
        }
    </style>
</body>

</html>