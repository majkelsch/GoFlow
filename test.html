<!DOCTYPE html>
<html>

<head>
    <base target="_top">
</head>

<body>
    <form id="dataForm">
        </label>
        <label>Client:
            <select name="client" required>
            </select>
            <input name="getProject" type="button" value="Get client [WIP]" onclick="getClientFromProject()">
        </label><br>

        <label>Project:
            <select name="project" required>
            </select>
            <input name="getProject" type="button" value="Get project [WIP]" onclick="getProjectFromClient()">
        </label><br>


        <label>Title: <input type="text" name="title" required></label><br>
        <label>Description:<br>
            <textarea name="description" rows="4" cols="50"></textarea>
        </label><br>
        <label>Employee:
            <select name="employee" required>

            </select>
        </label><br>
        <label>Priority:
            <select name="priority" required>

            </select>
        </label><br>
        <label>Status:
            <select name="status" required>

            </select>
        </label><br>

        <label>Due date:
            <input type="date" name="due_date">
        </label>
        <input type="submit" value="Create">
    </form>
    <script>
        document.addEventListener("DOMContentLoaded", function(event) {
            google.script.run.withSuccessHandler(populateClients).fetchFromServer('getClients');
            google.script.run.withSuccessHandler(populateProjects).fetchFromServer('getProjects');
            google.script.run.withSuccessHandler(populateEmployees).fetchFromServer('getEmployees');
            google.script.run.withSuccessHandler(populatePriorities).fetchFromServer('getTaskPriorities');
            google.script.run.withSuccessHandler(populateStatuses).fetchFromServer('getTaskStatuses');


        });

        function populateClients(data) {
            console.log("Received:", data);
            const clientSelect = document.querySelector('select[name="client"]');
            data.forEach(client => {
                if (client.first_name != "Null") {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.full_name;
                    clientSelect.appendChild(option);
                }
            });
        }

        function populateProjects(projects) {
            const projectSelect = document.querySelector('select[name="project"]');
            projects.forEach(project => {
                if (project.url != "Null") {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.url;
                    projectSelect.appendChild(option);
                }
            });
        }

        function populateEmployees(employees) {
            const employeeSelect = document.querySelector('select[name="employee"]');
            employees.forEach(employee => {
                if (employee.first_name != "Null") {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.full_name;
                    employeeSelect.appendChild(option);
                }
            });
        }

        function populatePriorities(priorities) {
            const prioritySelect = document.querySelector('select[name="priority"]');
            priorities.forEach(priority => {
                if (priority.name != "Null") {
                    const option = document.createElement('option');
                    option.value = priority.id;
                    option.textContent = priority.name;
                    prioritySelect.appendChild(option);
                }
            });
        }

        function populateStatuses(statuses) {
            const statusSelect = document.querySelector('select[name="status"]');
            statuses.forEach(status => {
                if (status.name != "Null") {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    statusSelect.appendChild(option);
                }
            });
        }

        function populateProjectsByClient(data) {

            const projectSelect = document.querySelector('select[name="project"]');

            projectSelect.innerHTML = ''; // Clear existing options
            data.forEach(project => {
                if (project.url != "Null") {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.url;
                    projectSelect.appendChild(option);
                }
            });
        }

        function populateClientsByProject(data) {

            const clientSelect = document.querySelector('select[name="client"]');

            clientSelect.innerHTML = ''; // Clear existing options
            data.forEach(client => {
                if (client.url != "Null") {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.full_name;
                    clientSelect.appendChild(option);
                }
            });
        }

        function getProjectFromClient() {

            const clientSelect = document.querySelector('select[name="client"]');
            const clientId = clientSelect.value;
            google.script.run.withSuccessHandler(populateProjectsByClient).fetchFromServer(`getProjectsByClient&client_id=${clientId}`);
        }

        function getClientFromProject() {

            const projectSelect = document.querySelector('select[name="project"]');
            const projectId = projectSelect.value;
            google.script.run.withSuccessHandler(populateClientsByProject).fetchFromServer(`getClientsByProject&project_id=${projectId}`);
        }
    </script>
    <script>
        document.getElementById("dataForm").addEventListener("submit", function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            var data = {
                command: "insert_task",
                data: {
                    client: formData.get("client"),
                    project: formData.get("project"),
                    title: formData.get("title"),
                    description: formData.get("description"),
                    employee: formData.get("employee"),
                    priority: formData.get("priority"),
                    status: formData.get("status"),
                    due_date: formData.get("due_date") || null
                }

            };
            google.script.run.withSuccessHandler().postToServer(data)
            google.script.host.close();

        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');
        body {
            font-family: Roboto;
        }
        
        form {
            display: flex;
            flex-direction: column;
            width: 300px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        
        form label {
            display: flex;
            flex-direction: column;
        }
        
        form input,
        form select,
        form textarea {
            font-family: Roboto;
            font-size: 16px;
            padding: 5px;
        }
        
        form textarea {
            resize: vertical;
        }
        
        form label {
            font-family: Roboto;
            font-size: 16px;
        }
        
        form input[type="submit"] {
            background-color: #006ee6;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            text-transform: uppercase;
        }
    </style>
</body>

</html>